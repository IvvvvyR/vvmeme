# 🦦 MemeMaster Pro (v6.4.0)

> **为 AstrBot 打造的拟人化情感伴侣插件**
> 集成了 智能防抖、表情包管理、长期记忆、思维链过滤 与 主动关怀系统。

![Version](https://img.shields.io/badge/version-6.4.0-blue) ![Platform](https://img.shields.io/badge/AstrBot-NapCat-green)

## ⚠️ 兼容性与重要说明

*   **适配环境**：本插件专为 **AstrBot + NapCat (OneBot v11)** 适配器设计。
*   **私聊特化**：作者主要在**私聊场景**下开发与测试。群聊环境虽然有逻辑支持，但未经验证，建议主要用于私聊陪伴。
*   **依赖**：需要 Python `Pillow` 库支持图片处理。

---

## ✨ 核心功能

### 1. ⏳ 智能防抖与聚合 (Debounce)
你是否厌倦了还没打完字机器人就秒回？
*   **模拟人类阅读节奏**：当你连续发送多条短消息（或图片+文字）时，机器人会等待几秒（可配），将它们打包成一段完整的上下文发给 LLM。
*   **输入状态过滤**：自动忽略 NapCat 上报的“正在输入”空事件，不再对着空气倒计时。

### 2. 🧠 长期记忆系统 (Long-term Memory)
让 AI 真正记住你们的过往。
*   **自动总结**：当对话积累到一定条数（如50条），自动触发 LLM 总结，将重要信息写入 `memory.txt`。
*   **智能注入**：根据设定的频率（如每50条），周期性地将长期记忆注入到 Prompt 中，防止 AI 聊久了“忘事”。
*   **Web端热修改**：你可以随时在 WebUI 查看、修改甚至回滚记忆文件。

### 3. 🖼️ 表情包管理 (Meme Gallery)
*   **自动进货**：当你发送图片时，后台静默请求 LLM 鉴定：“这是否是一张表情包？”。如果是，自动分类并保存。
*   **视觉指纹去重**：采用 dHash 算法，从不保存重复的图片，哪怕文件大小不同。
*   **Web 管理后台**：提供独立网页，支持批量上传、删除、修改标签、一键瘦身（压缩图片）。
*   **主动发图**：AI 会根据对话上下文，在回复中自动插入合适的表情包（支持动图/静图）。

### 4. 🧹 思维链净化 (CoT Filter)
专为 Gemini Flash Thinking / DeepSeek R1 等推理模型打造。
*   **强力过滤**：完美去除 `.thought ... End of thought` 或 XML 格式的思考过程，只保留最终回复。
*   **分段发送**：模拟人类打字习惯，将长回复按句意切分，并模拟打字延迟，拒绝“刷屏式”回复。

### 5. 👋 主动关怀 (Proactive)
*   **孤单看守者**：如果在设定时间内（如24小时）你没有说话，机器人会结合当前时间、长期记忆和最近的聊天记录，主动向你发起话题。
*   **防 OOC**：采用“导演式”Prompt，确保主动发起的话题符合人设，自然不突兀。

---

## ⚙️ WebUI 配置指南

插件启动后，访问 `http://你的IP:5000` 即可进入管理后台。

### 主要配置项说明

| 配置项 | 推荐值 | 说明 |
| :--- | :--- | :--- |
| **防抖等待 (秒)** | `10.0` - `20.0` | 等待你把话说完的时间。 |
| **发图概率 (%)** | `50` | AI 回复时带表情包的几率。 |
| **存图冷却 (秒)** | `60` | 防止连续发图刷爆 Token，每次自动鉴图的间隔。 |
| **记忆注入频率** | `50` | 每隔多少条对话，向 AI 提醒一次长期记忆。建议与总结阈值保持一致。 |
| **总结触发阈值** | `50` | buffer 攒够多少条对话写一次“日记”。 |
| **主动聊天间隔** | `0` 或 `1440` | 分钟数。0 为关闭。1440 为一天。 |
| **静默时间** | `23` - `7` | 晚上23点到早7点，机器人不会主动打扰你。 |

---

## 🛠️ 常见问题 (Q&A)

**Q: 为什么我看不到后台日志？**
A: 如果使用 Docker，请尝试 `docker logs -f <容器名>`。如果你配置了 `-p 5000:5000`，WebUI 的操作日志也会实时显示。

**Q: 为什么机器人回复有时候会卡一下？**
A: 如果机器人决定发表情包，上传图片到 QQ 服务器需要时间，这属于正常网络延迟。

**Q: 我可以直接修改 memory.txt 吗？**
A: 可以！推荐使用 WebUI 的备份功能下载修改后再恢复，或者使用支持 SFTP 的工具（如 MiXplorer / FinalShell）直接编辑。**注意编码必须是 UTF-8。**

**Q: 怎么触发主动发图？**
A: 不需要特殊指令。AI 会根据你的对话内容，自动判断是否需要回复 `MEME_TAG:xxx`，插件会将其拦截并转换为图片发送。

---

## 📥 安装方法

1.  将本插件文件夹放入 AstrBot 的 `data/plugins/` 目录下。
2.  确保你的 Docker 映射了端口 `5000` (用于 WebUI)。
3.  重启 AstrBot。
4.  访问 WebUI 进行初始化配置。

---

**Author:** Vvivloy
**License:** MIT
